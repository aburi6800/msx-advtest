# License:MIT License
# copyright-holders:aburi6800 (Hitoshi Iwai)

import sys
import unicodedata

# MSXの文字コードマッピング
convert_map = {
    ' ' : 0x20, '!' : 0x21, '\"': 0x22, '#' : 0x23, '$' : 0x24, 
    '%' : 0x25, '&' : 0x26, '\'': 0x27, '(' : 0x28, ')' : 0x29, 
    '*' : 0x2A, '+' : 0x2B, ',' : 0x2C, '-' : 0x2D, '.' : 0x2E, 
    '/' : 0x2F, 
    '0' : 0x30, '1' : 0x31, '2' : 0x32, '3' : 0x33, '4' : 0x34, 
    '5' : 0x35, '6' : 0x36, '7' : 0x37, '8' : 0x38, '9' : 0x39, 
    ':' : 0x3A, ';' : 0x3B, '<' : 0x3C, '=' : 0x3D, '>' : 0x3E, 
    '?' : 0x3F, '@' : 0x40, 
    'A' : 0x41, 'B' : 0x42, 'C' : 0x43, 'D' : 0x44, 'E' : 0x45, 
    'F' : 0x46, 'G' : 0x47, 'H' : 0x48, 'I' : 0x49, 'J' : 0x4A, 
    'K' : 0x4B, 'L' : 0x4C, 'M' : 0x4D, 'N' : 0x4E, 'O' : 0x4F, 
    'P' : 0x50, 'Q' : 0x51, 'R' : 0x52, 'S' : 0x53, 'T' : 0x54, 
    'U' : 0x55, 'V' : 0x56, 'W' : 0x57, 'X' : 0x58, 'Y' : 0x59, 
    'Z' : 0x5A, 
    '[' : 0x5B, '\\': 0x5C, ']' : 0x5D, '^' : 0x5E, '_': 0x5F,
    '`' : 0x60, 
    'を': 0x86, 
    'ぁ': 0x87, 'ぃ': 0x88, 'ぅ': 0x89, 'ぇ': 0x8A, 'ぉ': 0x8B,
    'ゃ': 0x8C, 'ゅ': 0x8D, 'ょ': 0x8E, 'っ': 0x8F,
    'あ': 0x91, 'い': 0x92, 'う': 0x93, 'え': 0x94, 'お': 0x95,
    'か': 0x96, 'き': 0x97, 'く': 0x98, 'け': 0x99, 'こ': 0x9A,
    'さ': 0x9B, 'し': 0x9C, 'す': 0x9D, 'せ': 0x9E, 'そ': 0x9F,
    '。': 0xA1, '「': 0xA2, '」': 0xA3, '、': 0xA4, '・': 0xA5, 
    'ヲ': 0xA6, 
    'ァ': 0xA7, 'ィ': 0xA8, 'ゥ': 0xA9, 'ェ': 0xAA, 'ォ': 0xAB,
    'ャ': 0xAC, 'ュ': 0xAD, 'ョ': 0xAE, 'ッ': 0xAF,
    'ー': 0xB0, 
    'ア': 0xB1, 'イ': 0xB2, 'ウ': 0xB3, 'エ': 0xB4, 'オ': 0xB5,
    'カ': 0xB6, 'キ': 0xB7, 'ク': 0xB8, 'ケ': 0xB9, 'コ': 0xBa,
    'サ': 0xBB, 'シ': 0xBC, 'ス': 0xBD, 'セ': 0xBE, 'ソ': 0xBF,
    'タ': 0xC0, 'チ': 0xC1, 'ツ': 0xC2, 'テ': 0xC3, 'ト': 0xC4,
    'ナ': 0xC5, 'ニ': 0xC6, 'ヌ': 0xC7, 'ネ': 0xC8, 'ノ': 0xC9,
    'ハ': 0xCA, 'ヒ': 0xCB, 'フ': 0xCC, 'ヘ': 0xCD, 'ホ': 0xCE,
    'マ': 0xCF, 'ミ': 0xD0, 'ム': 0xD1, 'メ': 0xD2, 'モ': 0xD3,
    'ヤ': 0xD4, 'ユ': 0xD5, 'ヨ': 0xD6,
    'ラ': 0xD7, 'リ': 0xD8, 'ル': 0xD9, 'レ': 0xDA, 'ロ': 0xDB,
    'ワ': 0xDC, 'ン': 0xDD,
    '゙': 0xDE, '゚': 0xDF,
    'た': 0xE0, 'ち': 0xE1, 'つ': 0xE2, 'て': 0xE3, 'と': 0xE4,
    'な': 0xE5, 'に': 0xE6, 'ぬ': 0xE7, 'ね': 0xE8, 'の': 0xE9,
    'は': 0xEA, 'ひ': 0xEB, 'ふ': 0xEC, 'へ': 0xED, 'ほ': 0xEE,
    'ま': 0xEF, 'み': 0xF0, 'む': 0xF1, 'め': 0xF2, 'も': 0xF3,
    'や': 0xF4, 'ゆ': 0xF5, 'よ': 0xF6,
    'ら': 0xF7, 'り': 0xF8, 'る': 0xF9, 'れ': 0xFA, 'ろ': 0xFB,
    'わ': 0xFC, 'ん': 0xFD,
}

def convert_char(c):
    # 正規化で濁点・半濁点を分離
    normalized = unicodedata.normalize('NFKD', c.upper())

    result = []
    for ch in normalized:
        if ch in convert_map:
            result.append(convert_map[ch])
        else:
            raise ValueError(f"未対応の文字です: '{c}'（正規化で得た文字: '{ch}'）")
    return result

def convert_string_to_msx_array(text):
    byte_array = []
    for c in text:
        byte_array.extend(convert_char(c))
    byte_array.append(0x00)  # null終端を追加
    return byte_array

def format_as_c_array(byte_array, name="str"):
    hex_values = ', '.join(f'0x{b:02X}' for b in byte_array)
    return f"uint8_t {name}[] = {{ {hex_values} }};"

# 実行エントリーポイント
if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("使い方: python msx_encode.py 'こんにちは、MSX！'")
        sys.exit(1)

    input_text = sys.argv[1]
    try:
        result = convert_string_to_msx_array(input_text)
        print(format_as_c_array(result))
    except ValueError as e:
        print("エラー:", e)
        sys.exit(1)
